<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式技術規格標記工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-200">

    <div class="flex h-screen bg-white">
        <!-- Left Sidebar (Tools) -->
        <aside id="toolbar" class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col p-4 space-y-4 flex-shrink-0">
            <h1 class="text-xl font-bold text-gray-800 px-2">標記工具</h1>
            
            <div class="flex-grow space-y-6 overflow-y-auto">
                <!-- Tools Group -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">工具</h2>
                    <div class="space-y-1">
                        <button id="measure-tool" class="sidebar-btn" title="測量尺寸 (Z)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="21" x2="17" y2="3"></line><line x1="7" y1="21" x2="7" y2="3"></line><line x1="21" y1="12" x2="3" y2="12"></line></svg>
                            <span>測量 (Z)</span>
                        </button>
                        <button id="arrow-tool" class="sidebar-btn" title="箭頭標記 (V)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            <span>箭頭 (V)</span>
                        </button>
                         <button id="text-tool" class="sidebar-btn" title="文字註釋 (T)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            <span>註釋 (T)</span>
                        </button>
                        <button id="zoom-annotation-tool" class="sidebar-btn" title="新增放大註釋 (A)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="12" height="12" rx="2"></rect>
                                <circle cx="8" cy="8" r="2"></circle>
                                <line x1="9.5" y1="9.5" x2="12" y2="12"></line>
                                <path d="M8 15v4l-2-2h4l-2 2v-4"></path>
                            </svg>
                            <span>放大註釋 (A)</span>
                        </button>
                    </div>
                </div>

                <!-- Settings Group -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">設定</h2>
                    <div class="space-y-3 px-2">
                         <div class="flex items-center justify-between">
                            <label for="color-picker" class="text-sm font-medium text-gray-700">顏色</label>
                            <input type="color" id="color-picker" value="#FF0000" class="w-8 h-8 rounded-md border-gray-300 cursor-pointer">
                        </div>
                         <div class="space-y-1">
                             <label for="line-width" class="text-sm font-medium text-gray-700">線寬: <span id="line-width-value" class="font-bold">3</span></label>
                             <input type="range" id="line-width" min="1" max="20" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                         </div>
                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-700">單位</label>
                            <div class="flex w-full">
                                <button id="unit-cm" class="w-1/2 py-1 px-2 border border-gray-300 rounded-l-md text-sm">cm</button>
                                <button id="unit-mm" class="w-1/2 py-1 px-2 border border-gray-300 border-l-0 rounded-r-md text-sm">mm</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Group -->
                 <div>
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">智慧功能</h2>
                    <button id="gemini-generate" class="sidebar-btn bg-purple-100 text-purple-800 hover:bg-purple-200" title="使用 AI 產生規格描述">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        <span>產生描述</span>
                    </button>
                 </div>
            </div>

            <!-- Actions Group -->
            <div class="space-y-1">
                <hr class="border-gray-200">
                 <button id="export-pdf-btn" class="sidebar-btn" title="將所有圖面導出為一份 PDF">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>導出 PDF</span>
                </button>
                 <button id="export-btn" class="sidebar-btn" title="導出單張產品製單">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>導出單頁</span>
                </button>
                <button id="copy-canvas" class="sidebar-btn" title="複製圖片到剪貼簿">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    <span>複製圖面</span>
                </button>
                 <button id="preview-tool" class="sidebar-btn" title="預覽模式">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                    <span>預覽</span>
                </button>
                <button id="undo-tool" class="sidebar-btn" title="復原 (Ctrl+Z)">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                    <span>復原</span>
                </button>
                <button id="clear-canvas" class="sidebar-btn" title="清除所有標記">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    <span>清除</span>
                </button>
                <button id="restart-btn" class="sidebar-btn" title="重新開始新案件">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"/></svg>
                    <span>重新開始</span>
                </button>
            </div>

        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-200">
             <header class="p-3 bg-white border-b border-gray-200 flex-shrink-0">
                <label for="imageLoader" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center gap-2 max-w-max">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    上傳圖片或貼上 (Ctrl+V)
                </label>
                <input type="file" id="imageLoader" class="hidden" accept="image/*" multiple/>
             </header>
             <div class="flex-1 p-4 flex items-center justify-center">
                <div id="canvas-container" class="relative w-full h-full bg-gray-300 rounded-lg shadow-inner overflow-hidden">
                    <div id="upload-container" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                        <svg class="w-24 h-24 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="text-2xl font-semibold text-gray-600">將圖片拖放到此處</h3>
                        <p class="text-gray-500 mt-2">或點擊左上方的「上傳圖片」按鈕</p>
                    </div>
                    <canvas id="canvas"></canvas>
                    <div id="copy-notification" class="absolute hidden items-center justify-center px-4 py-2 bg-black bg-opacity-70 text-white text-sm font-bold rounded-md">已複製！</div>
                </div>
             </div>
             <!-- Image Tray -->
            <div id="image-tray-wrapper" class="flex-shrink-0 p-2 border-t border-gray-300 hidden">
                <div id="image-tray" class="flex items-center space-x-2 overflow-x-auto">
                    <!-- Thumbnails will be injected here -->
                </div>
            </div>
        </main>
        
        <!-- Right Sidebar (Annotation List) -->
        <aside id="annotation-list-container" class="w-80 bg-white border-l border-gray-200 flex flex-col flex-shrink-0">
            <h2 class="p-4 text-lg font-bold text-gray-800 border-b border-gray-200">註釋列表</h2>
            <div id="annotation-list" class="flex-grow overflow-y-auto p-2 space-y-2">
                <!-- Annotation items will be injected here -->
                <p class="text-center text-gray-500 p-4">尚未有任何註釋</p>
            </div>
        </aside>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="hidden absolute bg-white shadow-lg rounded-md p-2 z-50">
        <div class="grid grid-cols-4 gap-2 mb-2" id="color-swatches">
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #EF4444;" data-color="#EF4444"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #3B82F6;" data-color="#3B82F6"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #22C55E;" data-color="#22C55E"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #EAB308;" data-color="#EAB308"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #8B5CF6;" data-color="#8B5CF6"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #000000;" data-color="#000000"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer" style="background-color: #6B7280;" data-color="#6B7280"></div>
            <div class="w-6 h-6 rounded-full cursor-pointer border border-gray-300" style="background-color: #FFFFFF;" data-color="#FFFFFF"></div>
        </div>
        <hr class="my-1 border-gray-200">
        <button id="context-copy-btn" class="text-sm w-full text-left p-1 hover:bg-gray-100 rounded">複製圖面</button>
    </div>


    <!-- Modals (unchanged) -->
    <div id="input-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4">輸入文字</h3>
            <input type="text" id="modal-input" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">取消</button>
                <button id="modal-ok" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">確定</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-2">確認操作</h3>
            <p id="confirm-modal-message" class="text-gray-600 mb-4">您確定嗎？</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">取消</button>
                <button id="confirm-modal-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">確定</button>
            </div>
        </div>
    </div>
    <div id="gemini-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">✨ AI 產生規格描述</h3>
                <button id="gemini-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </header>
            <div id="gemini-content-wrapper" class="p-6 overflow-y-auto">
                <div id="gemini-loader" class="flex flex-col items-center justify-center text-center py-10">
                    <div class="spinner"></div>
                    <p class="text-gray-600 mt-4">正在分析圖片與標註，請稍候...</p>
                </div>
                <div id="gemini-result" class="hidden prose max-w-none"></div>
            </div>
            <footer class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                 <button id="gemini-copy-btn" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    複製文字
                </button>
            </footer>
        </div>
    </div>
    <div class="preview-overlay hidden"></div>


    <!-- vibe code -->
    <link rel="stylesheet" href="vibe_annotation.css">
    <script src="vibe_annotation.js"></script>
</body>
</html>

